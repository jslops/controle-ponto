<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Controle de Ponto Digital - Sistema Gratuito</title>
    <meta name="description" content="Sistema gratuito de controle de ponto eletr√¥nico. Registre suas horas trabalhadas, calcule sal√°rios e gere relat√≥rios.">
    <meta name="theme-color" content="#3b82f6">
    <meta name="keywords" content="ponto eletr√¥nico, controle de horas, calcular sal√°rio, registro de ponto">
    
    <!-- Open Graph -->
    <meta property="og:title" content="Controle de Ponto Digital">
    <meta property="og:description" content="Sistema gratuito para controle de ponto eletr√¥nico">
    <meta property="og:type" content="website">
    
    <!-- Favicon -->
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>‚è∞</text></svg>">
    
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --primary: #3b82f6;
            --primary-dark: #1d4ed8;
            --secondary: #10b981;
            --secondary-dark: #047857;
            --accent: #8b5cf6;
            --accent-dark: #7c3aed;
            --neutral: #6b7280;
            --neutral-dark: #4b5563;
            --light: #f9fafb;
            --dark: #1f2937;
        }
        
        .tab-active {
            background-color: var(--primary);
            color: white;
        }
        .exceeded {
            background-color: #fee2e2;
        }
        .print-only {
            display: none;
        }
        .dashboard-card {
            transition: all 0.3s ease;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
        }
        .dashboard-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
        }
        .time-entry {
            transition: all 0.3s ease;
        }
        .time-entry:hover {
            background-color: #f8fafc;
        }
        @media print {
            .no-print {
                display: none !important;
            }
            .print-only {
                display: block;
            }
            body {
                font-size: 12px;
            }
            .container {
                max-width: 100% !important;
            }
        }
        .dark-mode {
            background-color: var(--dark);
            color: var(--light);
        }
        .dark-mode .bg-white {
            background-color: #374151;
        }
        .dark-mode .bg-gray-100 {
            background-color: #4b5563;
        }
        .dark-mode .border-gray-300 {
            border-color: #6b7280;
        }
        .dark-mode input, .dark-mode select {
            background-color: #4b5563;
            color: var(--light);
            border-color: #6b7280;
        }
        .login-container {
            max-width: 400px;
            margin: 50px auto;
            padding: 30px;
            border-radius: 16px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
            background: linear-gradient(145deg, #ffffff, #f3f4f6);
        }
        .hidden {
            display: none;
        }
        .admin-panel {
            background-color: #f8fafc;
            border-radius: 16px;
            padding: 25px;
            margin-top: 20px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
        }
        
        /* Melhorias para mobile */
        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }
            .grid-cols-1, .grid-cols-2, .grid-cols-3, .grid-cols-4 {
                grid-template-columns: 1fr !important;
            }
            .flex-wrap {
                flex-direction: column;
            }
            .month-tab {
                margin-bottom: 5px;
                text-align: center;
                padding: 10px 5px;
                font-size: 0.875rem;
            }
            .header-buttons {
                flex-direction: column;
                gap: 10px;
            }
            .header-buttons button {
                width: 100%;
            }
            .login-container {
                margin: 20px auto;
                padding: 20px;
            }
        }
        
        /* Loading animation */
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* Toast notifications */
        .toast {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 20px;
            background: var(--secondary);
            color: white;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            z-index: 1000;
            transform: translateX(150%);
            transition: transform 0.3s ease;
        }
        .toast.show {
            transform: translateX(0);
        }
        .toast.error {
            background: #ef4444;
        }
        .toast.warning {
            background: #f59e0b;
        }
        
        /* Bot√µes modernos */
        .btn-primary {
            background-color: var(--primary);
            color: white;
            border-radius: 8px;
            padding: 10px 16px;
            font-weight: 500;
            transition: all 0.2s ease;
        }
        .btn-primary:hover {
            background-color: var(--primary-dark);
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(59, 130, 246, 0.3);
        }
        
        .btn-secondary {
            background-color: var(--secondary);
            color: white;
            border-radius: 8px;
            padding: 10px 16px;
            font-weight: 500;
            transition: all 0.2s ease;
        }
        .btn-secondary:hover {
            background-color: var(--secondary-dark);
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(16, 185, 129, 0.3);
        }
        
        .btn-accent {
            background-color: var(--accent);
            color: white;
            border-radius: 8px;
            padding: 10px 16px;
            font-weight: 500;
            transition: all 0.2s ease;
        }
        .btn-accent:hover {
            background-color: var(--accent-dark);
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(139, 92, 246, 0.3);
        }
        
        /* Cards modernos */
        .modern-card {
            border-radius: 16px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
            padding: 24px;
            background: white;
            transition: all 0.3s ease;
        }
        .modern-card:hover {
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
        }
        
        /* Inputs modernos */
        .modern-input {
            border-radius: 8px;
            border: 1px solid #d1d5db;
            padding: 12px;
            width: 100%;
            transition: all 0.2s ease;
        }
        .modern-input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }
        
        /* Abas modernas */
        .modern-tabs {
            display: flex;
            border-radius: 12px;
            background-color: #f3f4f6;
            padding: 4px;
        }
        .modern-tab {
            flex: 1;
            text-align: center;
            padding: 12px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
            font-weight: 500;
        }
        .modern-tab.active {
            background-color: white;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        
        /* Indicador de modo de trabalho */
        .work-mode-indicator {
            display: inline-flex;
            align-items: center;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.875rem;
            font-weight: 500;
        }
        .work-mode-horista {
            background-color: rgba(59, 130, 246, 0.1);
            color: var(--primary);
        }
        .work-mode-mensalista {
            background-color: rgba(139, 92, 246, 0.1);
            color: var(--accent);
        }
    </style>
</head>
<body class="bg-gray-50">
    <!-- Toast Notification -->
    <div id="toast" class="toast hidden"></div>

    <!-- Tela de Login -->
    <div id="loginScreen" class="login-container">
        <div class="text-center mb-6">
            <h1 class="text-3xl font-bold text-blue-600">‚è∞ Controle de Ponto</h1>
            <p class="text-gray-600 mt-2">Sistema gratuito de ponto eletr√¥nico</p>
        </div>
        
        <div id="loginForm">
            <h2 class="text-xl font-bold mb-4 text-center">Login</h2>
            <div class="mb-4">
                <label for="loginUsername" class="block text-sm font-medium text-gray-700 mb-1">Usu√°rio:</label>
                <input type="text" id="loginUsername" class="modern-input" required>
            </div>
            <div class="mb-4">
                <label for="loginPassword" class="block text-sm font-medium text-gray-700 mb-1">Senha:</label>
                <input type="password" id="loginPassword" class="modern-input" required>
            </div>
            <div class="mb-4">
                <button id="loginBtn" class="btn-primary w-full flex items-center justify-center">
                    <span id="loginText">Entrar</span>
                    <div id="loginLoading" class="loading hidden ml-2"></div>
                </button>
            </div>
            <p class="text-center text-sm">
                N√£o tem uma conta? 
                <a href="#" id="showRegister" class="text-blue-500 hover:text-blue-700 font-medium">Cadastre-se</a>
            </p>
        </div>
        
        <div id="registerForm" class="hidden">
            <h2 class="text-xl font-bold mb-4 text-center">Cadastro</h2>
            <div class="mb-4">
                <label for="registerUsername" class="block text-sm font-medium text-gray-700 mb-1">Usu√°rio:</label>
                <input type="text" id="registerUsername" class="modern-input" required minlength="3">
                <p class="text-xs text-gray-500 mt-1">M√≠nimo 3 caracteres</p>
            </div>
            <div class="mb-4">
                <label for="registerPassword" class="block text-sm font-medium text-gray-700 mb-1">Senha:</label>
                <input type="password" id="registerPassword" class="modern-input" required minlength="4">
                <p class="text-xs text-gray-500 mt-1">M√≠nimo 4 caracteres</p>
            </div>
            <div class="mb-4">
                <label for="confirmPassword" class="block text-sm font-medium text-gray-700 mb-1">Confirmar Senha:</label>
                <input type="password" id="confirmPassword" class="modern-input" required>
            </div>
            <div class="mb-4">
                <button id="registerBtn" class="btn-secondary w-full flex items-center justify-center">
                    <span id="registerText">Cadastrar</span>
                    <div id="registerLoading" class="loading hidden ml-2"></div>
                </button>
            </div>
            <p class="text-center text-sm">
                J√° tem uma conta? 
                <a href="#" id="showLogin" class="text-blue-500 hover:text-blue-700 font-medium">Fa√ßa login</a>
            </p>
        </div>

        <!-- Informa√ß√µes do sistema -->
        <div class="mt-8 p-4 bg-blue-50 rounded-lg">
            <h3 class="font-bold text-blue-800 mb-2">üí° Como usar:</h3>
            <ul class="text-sm text-blue-700 space-y-1">
                <li>‚Ä¢ Cadastre-se e fa√ßa login</li>
                <li>‚Ä¢ Registre seus hor√°rios de trabalho</li>
                <li>‚Ä¢ Configure o valor da sua hora/aula</li>
                <li>‚Ä¢ Acompanhe relat√≥rios e c√°lculos autom√°ticos</li>
                <li>‚Ä¢ Todos os dados ficam salvos na nuvem</li>
            </ul>
        </div>
    </div>

    <!-- Painel Administrativo -->
    <div id="adminScreen" class="container mx-auto px-4 py-8 hidden">
        <header class="mb-8">
            <div class="flex justify-between items-center flex-wrap gap-4">
                <div>
                    <h1 class="text-3xl font-bold text-gray-800">‚öôÔ∏è Painel Administrativo</h1>
                    <p class="text-gray-600 mt-2">Gerenciamento de usu√°rios do sistema</p>
                </div>
                <button id="adminLogoutBtn" class="btn-primary bg-red-500 hover:bg-red-600">
                    <i class="fas fa-sign-out-alt"></i> Sair
                </button>
            </div>
        </header>

        <div class="admin-panel">
            <h2 class="text-xl font-bold mb-4">üë• Gerenciar Usu√°rios</h2>
            
            <div class="mb-6">
                <h3 class="font-medium mb-2">üîê Alterar Senha do Admin</h3>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                    <div>
                        <label for="currentPassword" class="block text-sm font-medium text-gray-700 mb-1">Senha Atual:</label>
                        <input type="password" id="currentPassword" class="modern-input">
                    </div>
                    <div>
                        <label for="newPassword" class="block text-sm font-medium text-gray-700 mb-1">Nova Senha:</label>
                        <input type="password" id="newPassword" class="modern-input" minlength="4">
                    </div>
                    <div>
                        <label for="confirmNewPassword" class="block text-sm font-medium text-gray-700 mb-1">Confirmar Nova Senha:</label>
                        <input type="password" id="confirmNewPassword" class="modern-input">
                    </div>
                </div>
                <button id="changeAdminPassword" class="btn-primary">
                    Alterar Senha
                </button>
            </div>
            
            <div class="mb-6">
                <h3 class="font-medium mb-2">üìã Lista de Usu√°rios</h3>
                <div class="overflow-x-auto">
                    <table class="w-full border-collapse">
                        <thead>
                            <tr class="bg-gray-100">
                                <th class="border border-gray-300 px-4 py-2 text-left">Usu√°rio</th>
                                <th class="border border-gray-300 px-4 py-2 text-left">A√ß√µes</th>
                            </tr>
                        </thead>
                        <tbody id="usersList">
                            <!-- Lista de usu√°rios ser√° preenchida via JavaScript -->
                        </tbody>
                    </table>
                </div>
            </div>
            
            <div>
                <h3 class="font-medium mb-2">‚ûï Criar Novo Usu√°rio</h3>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                    <div>
                        <label for="newUsername" class="block text-sm font-medium text-gray-700 mb-1">Usu√°rio:</label>
                        <input type="text" id="newUsername" class="modern-input" minlength="3">
                    </div>
                    <div>
                        <label for="newUserPassword" class="block text-sm font-medium text-gray-700 mb-1">Senha:</label>
                        <input type="password" id="newUserPassword" class="modern-input" minlength="4">
                    </div>
                    <div>
                        <label for="confirmNewUserPassword" class="block text-sm font-medium text-gray-700 mb-1">Confirmar Senha:</label>
                        <input type="password" id="confirmNewUserPassword" class="modern-input">
                    </div>
                </div>
                <button id="createUserBtn" class="btn-secondary">
                    Criar Usu√°rio
                </button>
            </div>
        </div>
    </div>

    <!-- Sistema de Controle de Ponto (ap√≥s login) -->
    <div id="appScreen" class="container mx-auto px-4 py-8 hidden">
        <!-- Cabe√ßalho -->
        <header class="mb-8">
            <div class="flex justify-between items-center flex-wrap gap-4">
                <div>
                    <h1 class="text-3xl font-bold text-gray-800">‚è∞ Controle de Ponto Digital</h1>
                    <div class="flex items-center mt-2">
                        <p class="text-gray-600">Bem-vindo, <span id="userWelcome" class="font-semibold"></span>!</p>
                        <span id="workModeIndicator" class="work-mode-indicator ml-3"></span>
                    </div>
                </div>
                <div class="flex space-x-4 header-buttons">
                    <button id="darkModeToggle" class="btn-primary bg-gray-200 hover:bg-gray-300 text-gray-800 no-print">
                        <i class="fas fa-moon"></i> Modo Escuro
                    </button>
                    <button id="exportBtn" class="btn-primary no-print">
                        <i class="fas fa-download"></i> Exportar
                    </button>
                    <button id="importBtn" class="btn-secondary no-print">
                        <i class="fas fa-upload"></i> Importar
                    </button>
                    <input type="file" id="importFile" class="hidden" accept=".json">
                    <button id="logoutBtn" class="btn-primary bg-red-500 hover:bg-red-600 no-print">
                        <i class="fas fa-sign-out-alt"></i> Sair
                    </button>
                </div>
            </div>
        </header>

        <!-- Dashboard Resumo -->
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8 no-print">
            <div class="dashboard-card modern-card">
                <div class="flex items-center">
                    <div class="bg-blue-100 p-3 rounded-lg mr-4">
                        <i class="fas fa-clock text-blue-600 text-xl"></i>
                    </div>
                    <div>
                        <p class="text-sm text-gray-600">Horas Este Per√≠odo</p>
                        <p class="text-2xl font-bold text-gray-800" id="dashboardHorasMes">00:00</p>
                    </div>
                </div>
            </div>
            
            <div class="dashboard-card modern-card">
                <div class="flex items-center">
                    <div class="bg-green-100 p-3 rounded-lg mr-4">
                        <i class="fas fa-money-bill-wave text-green-600 text-xl"></i>
                    </div>
                    <div>
                        <p class="text-sm text-gray-600">Sal√°rio Este Per√≠odo</p>
                        <p class="text-2xl font-bold text-gray-800" id="dashboardSalarioMes">R$ 0,00</p>
                    </div>
                </div>
            </div>
            
            <div class="dashboard-card modern-card">
                <div class="flex items-center">
                    <div class="bg-purple-100 p-3 rounded-lg mr-4">
                        <i class="fas fa-chart-line text-purple-600 text-xl"></i>
                    </div>
                    <div>
                        <p class="text-sm text-gray-600">M√©dia Horas/Semana</p>
                        <p class="text-2xl font-bold text-gray-800" id="dashboardMediaSemanal">00:00</p>
                    </div>
                </div>
            </div>
            
            <div class="dashboard-card modern-card">
                <div class="flex items-center">
                    <div class="bg-orange-100 p-3 rounded-lg mr-4">
                        <i class="fas fa-bolt text-orange-600 text-xl"></i>
                    </div>
                    <div>
                        <p class="text-sm text-gray-600">Horas Extras</p>
                        <p class="text-2xl font-bold text-gray-800" id="dashboardHorasExtras">00:00</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Controle de modo de trabalho -->
        <div class="mb-6 no-print">
            <div class="modern-card">
                <h2 class="text-xl font-bold mb-4">‚öôÔ∏è Configura√ß√µes de Trabalho</h2>
                <div class="modern-tabs mb-4">
                    <div class="modern-tab active" data-mode="horista">
                        <i class="fas fa-clock mr-2"></i> Horista
                    </div>
                    <div class="modern-tab" data-mode="mensalista">
                        <i class="fas fa-calendar-alt mr-2"></i> Mensalista
                    </div>
                </div>
                
                <!-- Configura√ß√µes espec√≠ficas para mensalista -->
                <div id="mensalistaConfig" class="hidden">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                        <div>
                            <label for="cargaHorariaMensal" class="block text-sm font-medium text-gray-700 mb-1">Carga Hor√°ria Mensal (horas):</label>
                            <input type="number" id="cargaHorariaMensal" class="modern-input" min="0" value="160">
                        </div>
                        <div>
                            <label for="salarioMensal" class="block text-sm font-medium text-gray-700 mb-1">Sal√°rio Mensal (R$):</label>
                            <input type="number" id="salarioMensal" class="modern-input" min="0" step="0.01" value="3000.00">
                        </div>
                    </div>
                    <div class="bg-blue-50 rounded-lg p-4">
                        <h3 class="font-medium text-blue-800 mb-2">Status do Per√≠odo</h3>
                        <div class="flex justify-between">
                            <span>Horas Trabalhadas:</span>
                            <span id="horasTrabalhadasMensal">00:00</span>
                        </div>
                        <div class="flex justify-between">
                            <span>Horas a Compensar/Pagar:</span>
                            <span id="horasCompensar">00:00</span>
                        </div>
                        <div class="flex justify-between font-bold mt-2">
                            <span>Valor a Compensar/Pagar:</span>
                            <span id="valorCompensar">R$ 0,00</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Per√≠odo de C√°lculo -->
        <div class="mb-6 no-print">
            <div class="modern-card">
                <h2 class="text-xl font-bold mb-4">üìÖ Per√≠odo de C√°lculo</h2>
                
                <div class="mb-4">
                    <label class="flex items-center mb-2">
                        <input type="radio" name="periodType" value="standard" class="mr-2" checked>
                        <span>Per√≠odo Padr√£o (16/M√™s Atual - 15/Pr√≥ximo M√™s)</span>
                    </label>
                    <label class="flex items-center">
                        <input type="radio" name="periodType" value="custom" class="mr-2">
                        <span>Per√≠odo Personalizado</span>
                    </label>
                </div>
                
                <div id="customPeriodConfig" class="hidden">
                    <div class="grid grid-cols-2 gap-4 mb-4">
                        <div>
                            <label for="periodStartDay" class="block text-sm font-medium text-gray-700 mb-1">
                                Dia de In√≠cio do Per√≠odo:
                            </label>
                            <input type="number" id="periodStartDay" class="modern-input" min="1" max="31" value="16">
                        </div>
                        <div>
                            <label for="periodEndDay" class="block text-sm font-medium text-gray-700 mb-1">
                                Dia de T√©rmino (autom√°tico):
                            </label>
                            <input type="number" id="periodEndDay" class="modern-input" disabled value="15">
                        </div>
                    </div>
                </div>
                
                <div class="bg-blue-50 rounded-lg p-4">
                    <h3 class="font-medium text-blue-800 mb-2">Per√≠odo Atual de C√°lculo:</h3>
                    <p id="currentPeriodDisplay" class="text-blue-700"></p>
                </div>
            </div>
        </div>

        <!-- Conte√∫do principal -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            <!-- Formul√°rio de registro -->
            <div class="modern-card no-print">
                <h2 class="text-xl font-bold mb-4">üìù Registrar Ponto</h2>
                <form id="pontoForm">
                    <div class="mb-4">
                        <label for="data" class="block text-sm font-medium text-gray-700 mb-1">Data:</label>
                        <input type="date" id="data" class="modern-input" required>
                    </div>
                    
                    <!-- Entradas e Sa√≠das Principais -->
                    <div class="mb-4">
                        <h3 class="font-medium mb-2 text-gray-700">Per√≠odo Principal</h3>
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label for="entrada" class="block text-sm font-medium text-gray-700 mb-1">Entrada:</label>
                                <input type="time" id="entrada" class="modern-input" required>
                            </div>
                            <div>
                                <label for="saida" class="block text-sm font-medium text-gray-700 mb-1">Sa√≠da:</label>
                                <input type="time" id="saida" class="modern-input" required>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Intervalos -->
                    <div class="mb-4">
                        <h3 class="font-medium mb-2 text-gray-700">Intervalos</h3>
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label for="intervaloSaida" class="block text-sm font-medium text-gray-700 mb-1">Sa√≠da Intervalo:</label>
                                <input type="time" id="intervaloSaida" class="modern-input">
                            </div>
                            <div>
                                <label for="intervaloRetorno" class="block text-sm font-medium text-gray-700 mb-1">Retorno Intervalo:</label>
                                <input type="time" id="intervaloRetorno" class="modern-input">
                            </div>
                        </div>
                    </div>
                    
                    <!-- Entradas e Sa√≠das Adicionais -->
                    <div class="mb-4">
                        <div class="flex justify-between items-center mb-2">
                            <h3 class="font-medium text-gray-700">Entradas/Sa√≠das Adicionais</h3>
                            <button type="button" id="adicionarHorario" class="btn-primary text-sm">
                                <i class="fas fa-plus"></i> Adicionar
                            </button>
                        </div>
                        <div id="horariosAdicionais" class="space-y-2">
                            <!-- Hor√°rios adicionais ser√£o inseridos aqui -->
                        </div>
                    </div>
                    
                    <div class="mb-4">
                        <label for="observacoes" class="block text-sm font-medium text-gray-700 mb-1">Observa√ß√µes (opcional):</label>
                        <textarea id="observacoes" class="modern-input" rows="2" placeholder="Anota√ß√µes sobre o dia..."></textarea>
                    </div>
                    
                    <div class="flex justify-between gap-4">
                        <button type="submit" class="btn-primary flex-1">
                            <i class="fas fa-save"></i> Salvar Registro
                        </button>
                        <button type="button" id="limparForm" class="btn-primary bg-gray-500 hover:bg-gray-600">
                            <i class="fas fa-times"></i> Limpar
                        </button>
                    </div>
                </form>
            </div>

            <!-- Configura√ß√µes de sal√°rio por hora/aula -->
            <div class="modern-card no-print">
                <h2 class="text-xl font-bold mb-4">üí∞ Configura√ß√µes de Sal√°rio</h2>
                
                <div class="mb-6">
                    <label for="valorHoraAula" class="block text-sm font-medium text-gray-700 mb-1">Valor da Hora/Aula (R$):</label>
                    <input type="number" id="valorHoraAula" step="0.01" min="0" class="modern-input" value="50.00">
                    <p class="text-xs text-gray-500 mt-1">Este valor ser√° usado para calcular seu sal√°rio</p>
                </div>

                <div class="mb-4">
                    <label for="valorHoraExtra" class="block text-sm font-medium text-gray-700 mb-1">Valor da Hora Extra (%):</label>
                    <input type="number" id="valorHoraExtra" step="1" min="0" class="modern-input" value="50">
                    <p class="text-xs text-gray-500 mt-1">Percentual de acr√©scimo para horas extras</p>
                </div>
                
                <div class="mb-4">
                    <h3 class="font-medium mb-2">üìä C√°lculo Autom√°tico</h3>
                    <div class="bg-gray-50 rounded-lg p-4">
                        <div class="flex justify-between mb-2">
                            <span>Total de Horas:</span>
                            <span id="infoTotalHoras">0h 0min</span>
                        </div>
                        <div class="flex justify-between mb-2">
                            <span>Horas Extras:</span>
                            <span id="infoHorasExtras">0h 0min</span>
                        </div>
                        <div class="flex justify-between mb-2">
                            <span>Valor Hora/Aula:</span>
                            <span id="infoValorHora">R$ 0,00</span>
                        </div>
                        <div class="flex justify-between font-bold border-t pt-2">
                            <span>Sal√°rio Bruto:</span>
                            <span id="infoSalarioBruto">R$ 0,00</span>
                        </div>
                    </div>
                </div>
                
                <h3 class="font-medium mb-2">üìâ Descontos Adicionais:</h3>
                <div id="descontosContainer" class="mb-4">
                    <!-- Descontos ser√£o adicionados aqui -->
                </div>
                
                <button id="adicionarDesconto" class="btn-primary bg-gray-500 hover:bg-gray-600 w-full mb-4">
                    <i class="fas fa-plus"></i> Adicionar Desconto
                </button>
                
                <button id="calcularSalario" class="btn-secondary w-full">
                    <i class="fas fa-calculator"></i> Calcular Sal√°rio Completo
                </button>
            </div>

            <!-- Resumo e gr√°ficos -->
            <div class="modern-card">
                <h2 class="text-xl font-bold mb-4">üìà Resumo do Per√≠odo</h2>
                
                <div class="grid grid-cols-2 gap-4 mb-6">
                    <div class="bg-blue-50 rounded-lg p-4">
                        <p class="text-sm text-blue-700">Total de Horas</p>
                        <p class="text-2xl font-bold text-blue-800" id="totalHoras">00:00</p>
                    </div>
                    <div class="bg-green-50 rounded-lg p-4">
                        <p class="text-sm text-green-700">Sal√°rio L√≠quido</p>
                        <p class="text-2xl font-bold text-green-800" id="salarioLiquido">R$ 0,00</p>
                    </div>
                </div>
                
                <div class="mb-6">
                    <h3 class="font-medium mb-2">Horas por Semana</h3>
                    <canvas id="horasSemanaisChart" height="150"></canvas>
                </div>
                
                <div class="no-print">
                    <button id="imprimirRelatorio" class="btn-accent w-full">
                        <i class="fas fa-print"></i> Imprimir Relat√≥rio
                    </button>
                </div>
            </div>
        </div>

        <!-- Gr√°fico de horas por dia -->
        <div class="modern-card mt-8">
            <h2 class="text-xl font-bold mb-4">üìä Horas Trabalhadas por Dia</h2>
            <canvas id="horasDiariasChart" height="100"></canvas>
        </div>

        <!-- Lista de registros -->
        <div class="modern-card mt-8">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-bold">üìã Registros do Per√≠odo</h2>
                <div class="text-sm text-gray-600">
                    <span id="totalRegistros">0</span> registros
                </div>
            </div>
            
            <div class="overflow-x-auto">
                <table class="w-full border-collapse">
                    <thead>
                        <tr class="bg-gray-100">
                            <th class="border border-gray-300 px-4 py-2 text-left">Data</th>
                            <th class="border border-gray-300 px-4 py-2 text-left">Entrada</th>
                            <th class="border border-gray-300 px-4 py-2 text-left">Sa√≠da</th>
                            <th class="border border-gray-300 px-4 py-2 text-left">Intervalo</th>
                            <th class="border border-gray-300 px-4 py-2 text-left">Total</th>
                            <th class="border border-gray-300 px-4 py-2 text-left">Observa√ß√µes</th>
                            <th class="border border-gray-300 px-4 py-2 text-left no-print">A√ß√µes</th>
                        </tr>
                    </thead>
                    <tbody id="registrosTabela">
                        <!-- Registros ser√£o preenchidos via JavaScript -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Modal para edi√ß√£o de registro -->
    <div id="editModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50">
        <div class="bg-white rounded-lg p-6 w-full max-w-md">
            <h3 class="text-xl font-bold mb-4">Editar Registro</h3>
            <form id="editForm">
                <input type="hidden" id="editId">
                <div class="mb-4">
                    <label for="editData" class="block text-sm font-medium text-gray-700 mb-1">Data:</label>
                    <input type="date" id="editData" class="modern-input" required>
                </div>
                <div class="grid grid-cols-2 gap-4 mb-4">
                    <div>
                        <label for="editEntrada" class="block text-sm font-medium text-gray-700 mb-1">Entrada:</label>
                        <input type="time" id="editEntrada" class="modern-input" required>
                    </div>
                    <div>
                        <label for="editSaida" class="block text-sm font-medium text-gray-700 mb-1">Sa√≠da:</label>
                        <input type="time" id="editSaida" class="modern-input" required>
                    </div>
                </div>
                <div class="grid grid-cols-2 gap-4 mb-4">
                    <div>
                        <label for="editIntervaloSaida" class="block text-sm font-medium text-gray-700 mb-1">Sa√≠da Intervalo:</label>
                        <input type="time" id="editIntervaloSaida" class="modern-input">
                    </div>
                    <div>
                        <label for="editIntervaloRetorno" class="block text-sm font-medium text-gray-700 mb-1">Retorno Intervalo:</label>
                        <input type="time" id="editIntervaloRetorno" class="modern-input">
                    </div>
                </div>
                <div class="mb-4">
                    <label for="editObservacoes" class="block text-sm font-medium text-gray-700 mb-1">Observa√ß√µes:</label>
                    <textarea id="editObservacoes" class="modern-input" rows="2"></textarea>
                </div>
                <div class="flex justify-end gap-4">
                    <button type="button" id="cancelEdit" class="btn-primary bg-gray-500 hover:bg-gray-600">
                        Cancelar
                    </button>
                    <button type="submit" class="btn-primary">
                        Salvar
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal de resultado de c√°lculo -->
    <div id="resultModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50">
        <div class="bg-white rounded-lg p-6 w-full max-w-md">
            <h3 class="text-xl font-bold mb-4">üí∞ C√°lculo de Sal√°rio</h3>
            <div id="resultContent" class="space-y-2">
                <!-- Conte√∫do ser√° preenchido via JavaScript -->
            </div>
            <div class="mt-6 flex justify-end">
                <button id="closeResult" class="btn-primary">
                    Fechar
                </button>
            </div>
        </div>
    </div>

    <!-- Configura√ß√£o do JSONBin -->
    <div id="configModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50">
        <div class="bg-white rounded-lg p-6 w-full max-w-md">
            <h3 class="text-xl font-bold mb-4">‚öôÔ∏è Configura√ß√£o do JSONBin</h3>
            <div class="mb-4">
                <p class="text-sm text-gray-600 mb-4">
                    Para usar o sistema, voc√™ precisa configurar uma conta no JSONBin.io e inserir sua chave de API e ID do bin abaixo.
                </p>
                <label for="jsonBinApiKey" class="block text-sm font-medium text-gray-700 mb-1">Chave da API JSONBin:</label>
                <input type="text" id="jsonBinApiKey" class="modern-input" placeholder="Sua chave de API">
            </div>
            <div class="mb-4">
                <label for="jsonBinId" class="block text-sm font-medium text-gray-700 mb-1">ID do Bin:</label>
                <input type="text" id="jsonBinId" class="modern-input" placeholder="ID do seu bin">
            </div>
            <div class="bg-blue-50 rounded-lg p-4 mb-4">
                <h4 class="font-medium text-blue-800 mb-2">Como obter essas informa√ß√µes:</h4>
                <ol class="text-sm text-blue-700 list-decimal pl-4 space-y-1">
                    <li>Crie uma conta em <a href="https://jsonbin.io" target="_blank" class="underline">jsonbin.io</a></li>
                    <li>V√° para "My Bins" e crie um novo bin</li>
                    <li>Copie o "Bin ID"</li>
                    <li>V√° para "API Keys" e copie sua "Secret Key"</li>
                </ol>
            </div>
            <div class="flex justify-end gap-4">
                <button id="cancelConfig" class="btn-primary bg-gray-500 hover:bg-gray-600">
                    Cancelar
                </button>
                <button id="saveConfig" class="btn-primary">
                    Salvar
                </button>
            </div>
        </div>
    </div>

    <script>
        // =============================================
        // CONFIGURA√á√ÉO DO JSONBIN
        // =============================================
        // Credenciais j√° configuradas para uso imediato
        const DEFAULT_JSONBIN_CONFIG = {
            apiKey: '$2a$10$AKM30q2AE/6WJhXqS2dft.8Luvw0h6GHLQWhtcUBQc12SCGK3oRra',
            binId: '6909065ed0ea881f40d1a114'
        };

        // =============================================
        // VARI√ÅVEIS GLOBAIS
        // =============================================
        let currentUser = null;
        let usersData = {};
        let currentMonth = new Date().getMonth();
        let currentYear = new Date().getFullYear();
        let registros = [];
        let workMode = 'horista'; // 'horista' ou 'mensalista'
        let jsonBinConfig = { ...DEFAULT_JSONBIN_CONFIG };
        
        // =============================================
        // SISTEMA DE PER√çODO DE C√ÅLCULO (NOVO)
        // =============================================
        let calculationPeriod = {
            startDay: 16, // Dia de in√≠cio do per√≠odo (padr√£o: 16)
            customPeriod: false // Se usa per√≠odo personalizado
        };

        // =============================================
        // FUN√á√ïES DE MANIPULA√á√ÉO DE DATA CORRIGIDAS
        // =============================================

        // Converter data para formato brasileiro (DD/MM/AAAA) sem problemas de fuso
        function toBrazilianDate(dateString) {
            if (!dateString) return '';
            
            // Para evitar problemas de fuso hor√°rio, trabalhamos com a data como string
            const [year, month, day] = dateString.split('-');
            return `${day.padStart(2, '0')}/${month.padStart(2, '0')}/${year}`;
        }

        // Converter para formato ISO sem problemas de fuso (YYYY-MM-DD)
        function toISODate(dateString) {
            if (!dateString) return '';
            
            // Se j√° estiver no formato ISO, retorna como est√°
            if (dateString.includes('-')) {
                return dateString;
            }
            
            // Se estiver no formato brasileiro, converte
            if (dateString.includes('/')) {
                const [day, month, year] = dateString.split('/');
                return `${year}-${month.padStart(2, '0')}-${day.padStart(2, '0')}`;
            }
            
            return dateString;
        }

        // Obter data atual no formato brasileiro (CORRE√á√ÉO DO FUSO HOR√ÅRIO)
        function getCurrentBrazilianDate() {
            const now = new Date();
            // Ajustar para fuso de Bras√≠lia (UTC-3)
            const offset = -3 * 60; // Bras√≠lia UTC-3 em minutos
            const brasiliaTime = new Date(now.getTime() + offset * 60 * 1000);
            
            const year = brasiliaTime.getUTCFullYear();
            const month = String(brasiliaTime.getUTCMonth() + 1).padStart(2, '0');
            const day = String(brasiliaTime.getUTCDate()).padStart(2, '0');
            
            return `${year}-${month}-${day}`;
        }

        // Obter o per√≠odo de c√°lculo para uma data espec√≠fica
        function getCalculationPeriod(dateString = null) {
            const date = dateString ? new Date(dateString) : new Date();
            const year = date.getFullYear();
            const month = date.getMonth();
            
            if (calculationPeriod.customPeriod) {
                // Usar per√≠odo personalizado (ex: 01 a 30)
                const startDate = new Date(year, month, calculationPeriod.startDay);
                const endDate = new Date(year, month + 1, calculationPeriod.startDay - 1);
                return { startDate, endDate };
            } else {
                // Usar per√≠odo padr√£o (16 a 15)
                let startDate, endDate;
                
                if (date.getDate() >= calculationPeriod.startDay) {
                    // Segunda metade do m√™s
                    startDate = new Date(year, month, calculationPeriod.startDay);
                    endDate = new Date(year, month + 1, calculationPeriod.startDay - 1);
                } else {
                    // Primeira metade do m√™s
                    startDate = new Date(year, month - 1, calculationPeriod.startDay);
                    endDate = new Date(year, month, calculationPeriod.startDay - 1);
                }
                
                return { startDate, endDate };
            }
        }

        // Filtrar registros pelo per√≠odo de c√°lculo
        function getRegistrosPorPeriodo() {
            const { startDate, endDate } = getCalculationPeriod();
            
            return registros.filter(reg => {
                const regDate = new Date(reg.data);
                return regDate >= startDate && regDate <= endDate;
            });
        }

        // Atualizar exibi√ß√£o do per√≠odo atual
        function updateCurrentPeriodDisplay() {
            const { startDate, endDate } = getCalculationPeriod();
            
            const formatDate = (date) => {
                return date.toLocaleDateString('pt-BR');
            };
            
            const display = document.getElementById('currentPeriodDisplay');
            display.textContent = `${formatDate(startDate)} √† ${formatDate(endDate)}`;
        }

        // =============================================
        // INICIALIZA√á√ÉO
        // =============================================
        document.addEventListener('DOMContentLoaded', function() {
            // Verificar se h√° configura√ß√£o salva
            const savedConfig = localStorage.getItem('jsonBinConfig');
            if (savedConfig) {
                jsonBinConfig = JSON.parse(savedConfig);
            }

            // Verificar se h√° usu√°rio logado
            const loggedInUser = localStorage.getItem('loggedInUser');
            if (loggedInUser) {
                currentUser = JSON.parse(loggedInUser);
                if (currentUser.username === 'admin') {
                    showAdminScreen();
                } else {
                    loadUserData();
                }
            } else {
                showLoginScreen();
            }

            // Configurar eventos
            setupEventListeners();
            initializeYearSelect();
            updateMonthTabs();
            loadMensalistaConfig();
            
            // Configurar data atual no formul√°rio (CORRE√á√ÉO DO FUSO HOR√ÅRIO)
            document.getElementById('data').value = getCurrentBrazilianDate();
        });

        // =============================================
        // CONFIGURA√á√ÉO DE EVENTOS
        // =============================================
        function setupEventListeners() {
            // Login/Registro
            document.getElementById('loginBtn').addEventListener('click', handleLogin);
            document.getElementById('registerBtn').addEventListener('click', handleRegister);
            document.getElementById('showRegister').addEventListener('click', showRegisterForm);
            document.getElementById('showLogin').addEventListener('click', showLoginForm);
            
            // Logout
            document.getElementById('logoutBtn').addEventListener('click', handleLogout);
            document.getElementById('adminLogoutBtn').addEventListener('click', handleLogout);
            
            // Formul√°rio de ponto
            document.getElementById('pontoForm').addEventListener('submit', handlePontoSubmit);
            document.getElementById('limparForm').addEventListener('click', limparFormulario);
            document.getElementById('adicionarHorario').addEventListener('click', adicionarHorario);
            
            // Configura√ß√µes de sal√°rio
            document.getElementById('calcularSalario').addEventListener('click', calcularSalarioCompleto);
            document.getElementById('adicionarDesconto').addEventListener('click', adicionarDesconto);
            document.getElementById('valorHoraAula').addEventListener('change', atualizarCalculos);
            document.getElementById('valorHoraExtra').addEventListener('change', atualizarCalculos);
            
            // Navega√ß√£o
            document.getElementById('yearSelect').addEventListener('change', function() {
                currentYear = parseInt(this.value);
                updateMonthTabs();
                carregarRegistrosMes();
            });
            
            // Impress√£o
            document.getElementById('imprimirRelatorio').addEventListener('click', imprimirRelatorio);
            
            // Exporta√ß√£o/Importa√ß√£o
            document.getElementById('exportBtn').addEventListener('click', exportarDados);
            document.getElementById('importBtn').addEventListener('click', () => document.getElementById('importFile').click());
            document.getElementById('importFile').addEventListener('change', importarDados);
            
            // Modo escuro
            document.getElementById('darkModeToggle').addEventListener('click', toggleDarkMode);
            
            // Modal de edi√ß√£o
            document.getElementById('cancelEdit').addEventListener('click', fecharModalEdicao);
            document.getElementById('editForm').addEventListener('submit', handleEditSubmit);
            
            // Modal de resultado
            document.getElementById('closeResult').addEventListener('click', fecharModalResultado);
            
            // Configura√ß√£o do JSONBin
            document.getElementById('saveConfig').addEventListener('click', saveJsonBinConfig);
            document.getElementById('cancelConfig').addEventListener('click', closeConfigModal);
            
            // Modo de trabalho
            document.querySelectorAll('.modern-tab').forEach(tab => {
                tab.addEventListener('click', function() {
                    document.querySelectorAll('.modern-tab').forEach(t => t.classList.remove('active'));
                    this.classList.add('active');
                    workMode = this.dataset.mode;
                    updateWorkModeUI();
                    saveUserData();
                });
            });
            
            // Configura√ß√µes de mensalista
            document.getElementById('cargaHorariaMensal').addEventListener('change', saveMensalistaConfig);
            document.getElementById('salarioMensal').addEventListener('change', saveMensalistaConfig);
            
            // Admin
            document.getElementById('changeAdminPassword').addEventListener('click', changeAdminPassword);
            document.getElementById('createUserBtn').addEventListener('click', createUser);
            
            // Per√≠odo de c√°lculo (NOVO)
            document.querySelectorAll('input[name="periodType"]').forEach(radio => {
                radio.addEventListener('change', function() {
                    calculationPeriod.customPeriod = (this.value === 'custom');
                    document.getElementById('customPeriodConfig').classList.toggle('hidden', !calculationPeriod.customPeriod);
                    carregarRegistrosMes();
                    atualizarCalculos();
                });
            });
            
            document.getElementById('periodStartDay').addEventListener('change', function() {
                calculationPeriod.startDay = parseInt(this.value);
                document.getElementById('periodEndDay').value = this.value - 1;
                carregarRegistrosMes();
                atualizarCalculos();
            });
        }

        // =============================================
        // FUN√á√ïES DE AUTENTICA√á√ÉO
        // =============================================
        async function handleLogin() {
            const username = document.getElementById('loginUsername').value;
            const password = document.getElementById('loginPassword').value;
            
            if (!username || !password) {
                showToast('Preencha todos os campos', 'error');
                return;
            }
            
            // Mostrar loading
            document.getElementById('loginText').classList.add('hidden');
            document.getElementById('loginLoading').classList.remove('hidden');
            
            try {
                // Carregar dados do JSONBin
                await loadAllUsersData();
                
                // Verificar credenciais
                if (username === 'admin' && password === usersData.admin?.password) {
                    currentUser = { username: 'admin' };
                    localStorage.setItem('loggedInUser', JSON.stringify(currentUser));
                    showAdminScreen();
                    showToast('Login realizado com sucesso!', 'success');
                } else if (usersData[username] && usersData[username].password === password) {
                    currentUser = { username };
                    localStorage.setItem('loggedInUser', JSON.stringify(currentUser));
                    loadUserData();
                    showToast('Login realizado com sucesso!', 'success');
                } else {
                    showToast('Usu√°rio ou senha incorretos', 'error');
                }
            } catch (error) {
                console.error('Erro no login:', error);
                showToast('Erro ao fazer login. Verifique sua conex√£o.', 'error');
            } finally {
                // Ocultar loading
                document.getElementById('loginText').classList.remove('hidden');
                document.getElementById('loginLoading').classList.add('hidden');
            }
        }

        async function handleRegister() {
            const username = document.getElementById('registerUsername').value;
            const password = document.getElementById('registerPassword').value;
            const confirmPassword = document.getElementById('confirmPassword').value;
            
            if (!username || !password || !confirmPassword) {
                showToast('Preencha todos os campos', 'error');
                return;
            }
            
            if (password !== confirmPassword) {
                showToast('As senhas n√£o coincidem', 'error');
                return;
            }
            
            if (username.length < 3) {
                showToast('O usu√°rio deve ter pelo menos 3 caracteres', 'error');
                return;
            }
            
            if (password.length < 4) {
                showToast('A senha deve ter pelo menos 4 caracteres', 'error');
                return;
            }
            
            // Mostrar loading
            document.getElementById('registerText').classList.add('hidden');
            document.getElementById('registerLoading').classList.remove('hidden');
            
            try {
                // Carregar dados existentes
                await loadAllUsersData();
                
                // Verificar se o usu√°rio j√° existe
                if (usersData[username]) {
                    showToast('Este usu√°rio j√° existe', 'error');
                    return;
                }
                
                // Criar novo usu√°rio
                usersData[username] = {
                    password: password,
                    registros: [],
                    settings: {
                        valorHoraAula: 50.00,
                        valorHoraExtra: 50,
                        workMode: 'horista',
                        mensalistaConfig: {
                            cargaHorariaMensal: 160,
                            salarioMensal: 3000.00
                        },
                        calculationPeriod: calculationPeriod // Salvar configura√ß√£o do per√≠odo
                    },
                    descontos: []
                };
                
                // Salvar dados atualizados
                await saveAllUsersData();
                
                showToast('Usu√°rio criado com sucesso!', 'success');
                showLoginForm();
                
                // Limpar formul√°rio
                document.getElementById('registerUsername').value = '';
                document.getElementById('registerPassword').value = '';
                document.getElementById('confirmPassword').value = '';
            } catch (error) {
                console.error('Erro no cadastro:', error);
                showToast('Erro ao criar usu√°rio. Verifique sua conex√£o.', 'error');
            } finally {
                // Ocultar loading
                document.getElementById('registerText').classList.remove('hidden');
                document.getElementById('registerLoading').classList.add('hidden');
            }
        }

        function handleLogout() {
            currentUser = null;
            localStorage.removeItem('loggedInUser');
            showLoginScreen();
            showToast('Logout realizado com sucesso', 'success');
        }

        // =============================================
        // FUN√á√ïES DE INTERFACE
        // =============================================
        function showLoginScreen() {
            document.getElementById('loginScreen').classList.remove('hidden');
            document.getElementById('appScreen').classList.add('hidden');
            document.getElementById('adminScreen').classList.add('hidden');
        }

        function showAppScreen() {
            document.getElementById('loginScreen').classList.add('hidden');
            document.getElementById('appScreen').classList.remove('hidden');
            document.getElementById('adminScreen').classList.add('hidden');
            
            // Atualizar interface do usu√°rio
            document.getElementById('userWelcome').textContent = currentUser.username;
            updateWorkModeUI();
            carregarRegistrosMes();
            atualizarDashboard();
            updateCurrentPeriodDisplay();
        }

        function showAdminScreen() {
            document.getElementById('loginScreen').classList.add('hidden');
            document.getElementById('appScreen').classList.add('hidden');
            document.getElementById('adminScreen').classList.remove('hidden');
            
            loadUsersList();
        }

        function showLoginForm() {
            document.getElementById('loginForm').classList.remove('hidden');
            document.getElementById('registerForm').classList.add('hidden');
        }

        function showRegisterForm() {
            document.getElementById('loginForm').classList.add('hidden');
            document.getElementById('registerForm').classList.remove('hidden');
        }

        function showConfigModal() {
            document.getElementById('configModal').classList.remove('hidden');
            document.getElementById('jsonBinApiKey').value = jsonBinConfig.apiKey;
            document.getElementById('jsonBinId').value = jsonBinConfig.binId;
        }

        function closeConfigModal() {
            document.getElementById('configModal').classList.add('hidden');
        }

        // =============================================
        // FUN√á√ïES DO JSONBIN
        // =============================================
        async function loadAllUsersData() {
            try {
                const response = await fetch(`https://api.jsonbin.io/v3/b/${jsonBinConfig.binId}/latest`, {
                    headers: {
                        'X-Master-Key': jsonBinConfig.apiKey
                    }
                });
                
                if (!response.ok) {
                    throw new Error('Erro ao carregar dados');
                }
                
                const data = await response.json();
                usersData = data.record || {};
                
                // Se n√£o houver dados de admin, criar um padr√£o
                if (!usersData.admin) {
                    usersData.admin = {
                        password: 'admin123',
                        registros: [],
                        settings: {}
                    };
                    await saveAllUsersData();
                }
                
                return usersData;
            } catch (error) {
                console.error('Erro ao carregar dados:', error);
                
                // Se n√£o conseguir carregar, mostrar modal de configura√ß√£o
                if (error.message.includes('404') || error.message.includes('403')) {
                    showConfigModal();
                } else {
                    showToast('Erro ao carregar dados. Verifique sua conex√£o.', 'error');
                }
                
                return {};
            }
        }

        async function saveAllUsersData() {
            try {
                const response = await fetch(`https://api.jsonbin.io/v3/b/${jsonBinConfig.binId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Master-Key': jsonBinConfig.apiKey
                    },
                    body: JSON.stringify(usersData)
                });
                
                if (!response.ok) {
                    throw new Error('Erro ao salvar dados');
                }
                
                return true;
            } catch (error) {
                console.error('Erro ao salvar dados:', error);
                showToast('Erro ao salvar dados. Verifique sua conex√£o.', 'error');
                return false;
            }
        }

        function saveJsonBinConfig() {
            const apiKey = document.getElementById('jsonBinApiKey').value;
            const binId = document.getElementById('jsonBinId').value;
            
            if (!apiKey || !binId) {
                showToast('Preencha todos os campos', 'error');
                return;
            }
            
            jsonBinConfig = { apiKey, binId };
            localStorage.setItem('jsonBinConfig', JSON.stringify(jsonBinConfig));
            
            closeConfigModal();
            showToast('Configura√ß√£o salva com sucesso!', 'success');
            
            // Recarregar dados
            if (currentUser) {
                if (currentUser.username === 'admin') {
                    loadUsersList();
                } else {
                    loadUserData();
                }
            }
        }

        // =============================================
        // FUN√á√ïES DE DADOS DO USU√ÅRIO
        // =============================================
        async function loadUserData() {
            try {
                await loadAllUsersData();
                
                if (usersData[currentUser.username]) {
                    const userData = usersData[currentUser.username];
                    registros = userData.registros || [];
                    
                    // Carregar configura√ß√µes
                    if (userData.settings) {
                        document.getElementById('valorHoraAula').value = userData.settings.valorHoraAula || 50.00;
                        document.getElementById('valorHoraExtra').value = userData.settings.valorHoraExtra || 50;
                        workMode = userData.settings.workMode || 'horista';
                        
                        // Carregar configura√ß√£o do per√≠odo de c√°lculo
                        if (userData.settings.calculationPeriod) {
                            calculationPeriod = userData.settings.calculationPeriod;
                            document.querySelector(`input[name="periodType"][value="${calculationPeriod.customPeriod ? 'custom' : 'standard'}"]`).checked = true;
                            document.getElementById('periodStartDay').value = calculationPeriod.startDay;
                            document.getElementById('periodEndDay').value = calculationPeriod.startDay - 1;
                            document.getElementById('customPeriodConfig').classList.toggle('hidden', !calculationPeriod.customPeriod);
                        }
                        
                        // Atualizar modo de trabalho na UI
                        document.querySelectorAll('.modern-tab').forEach(tab => {
                            tab.classList.remove('active');
                            if (tab.dataset.mode === workMode) {
                                tab.classList.add('active');
                            }
                        });
                        
                        updateWorkModeUI();
                        
                        // Carregar configura√ß√µes de mensalista
                        if (userData.settings.mensalistaConfig) {
                            document.getElementById('cargaHorariaMensal').value = userData.settings.mensalistaConfig.cargaHorariaMensal || 160;
                            document.getElementById('salarioMensal').value = userData.settings.mensalistaConfig.salarioMensal || 3000.00;
                        }
                    }
                    
                    // Carregar descontos
                    if (userData.descontos) {
                        loadDescontos(userData.descontos);
                    }
                    
                    showAppScreen();
                } else {
                    showToast('Erro ao carregar dados do usu√°rio', 'error');
                }
            } catch (error) {
                console.error('Erro ao carregar dados do usu√°rio:', error);
                showToast('Erro ao carregar dados do usu√°rio', 'error');
            }
        }

        async function saveUserData() {
            if (!currentUser || currentUser.username === 'admin') return;
            
            try {
                // Atualizar dados do usu√°rio
                usersData[currentUser.username] = {
                    ...usersData[currentUser.username],
                    password: usersData[currentUser.username].password,
                    registros: registros,
                    settings: {
                        valorHoraAula: parseFloat(document.getElementById('valorHoraAula').value),
                        valorHoraExtra: parseInt(document.getElementById('valorHoraExtra').value),
                        workMode: workMode,
                        calculationPeriod: calculationPeriod, // Salvar configura√ß√£o do per√≠odo
                        mensalistaConfig: {
                            cargaHorariaMensal: parseInt(document.getElementById('cargaHorariaMensal').value),
                            salarioMensal: parseFloat(document.getElementById('salarioMensal').value)
                        }
                    },
                    descontos: getDescontos()
                };
                
                // Salvar no JSONBin
                await saveAllUsersData();
            } catch (error) {
                console.error('Erro ao salvar dados do usu√°rio:', error);
                showToast('Erro ao salvar dados', 'error');
            }
        }

        // =============================================
        // FUN√á√ïES DO SISTEMA DE PONTO
        // =============================================
        async function handlePontoSubmit(e) {
            e.preventDefault();
            
            const data = document.getElementById('data').value;
            const entrada = document.getElementById('entrada').value;
            const saida = document.getElementById('saida').value;
            const intervaloSaida = document.getElementById('intervaloSaida').value;
            const intervaloRetorno = document.getElementById('intervaloRetorno').value;
            const observacoes = document.getElementById('observacoes').value;
            
            if (!data || !entrada || !saida) {
                showToast('Preencha pelo menos data, entrada e sa√≠da', 'error');
                return;
            }
            
            // CORRE√á√ÉO: Garantir que a data seja salva exatamente como informada
            const dataCorrigida = toISODate(data);
            
            // Coletar hor√°rios adicionais
            const horariosAdicionais = [];
            document.querySelectorAll('.horario-adicional').forEach(div => {
                const entradaAdd = div.querySelector('.entrada-adicional').value;
                const saidaAdd = div.querySelector('.saida-adicional').value;
                
                if (entradaAdd && saidaAdd) {
                    horariosAdicionais.push({ entrada: entradaAdd, saida: saidaAdd });
                }
            });
            
            // Calcular total de horas
            const totalHoras = calcularHorasTrabalhadas(entrada, saida, intervaloSaida, intervaloRetorno, horariosAdicionais);
            
            // Criar registro
            const registro = {
                id: Date.now(),
                data: dataCorrigida, // Usar data corrigida
                entrada,
                saida,
                intervaloSaida: intervaloSaida || '',
                intervaloRetorno: intervaloRetorno || '',
                horariosAdicionais,
                totalHoras,
                observacoes
            };
            
            // Adicionar aos registros
            registros.push(registro);
            
            // Salvar dados
            await saveUserData();
            
            // Atualizar interface
            carregarRegistrosMes();
            atualizarDashboard();
            limparFormulario();
            
            showToast('Registro salvo com sucesso!', 'success');
        }

        function calcularHorasTrabalhadas(entrada, saida, intervaloSaida, intervaloRetorno, horariosAdicionais = []) {
            // Converter para minutos
            function toMinutes(time) {
                if (!time) return 0;
                const [hours, minutes] = time.split(':').map(Number);
                return hours * 60 + minutes;
            }
            
            function toTimeString(minutes) {
                const hours = Math.floor(minutes / 60);
                const mins = minutes % 60;
                return `${hours.toString().padStart(2, '0')}:${mins.toString().padStart(2, '0')}`;
            }
            
            // Calcular horas do per√≠odo principal
            let totalMinutes = toMinutes(saida) - toMinutes(entrada);
            
            // Subtrair intervalo
            if (intervaloSaida && intervaloRetorno) {
                totalMinutes -= (toMinutes(intervaloRetorno) - toMinutes(intervaloSaida));
            }
            
            // Adicionar hor√°rios adicionais
            horariosAdicionais.forEach(horario => {
                totalMinutes += toMinutes(horario.saida) - toMinutes(horario.entrada);
            });
            
            return toTimeString(totalMinutes);
        }

        function carregarRegistrosMes() {
            const tabela = document.getElementById('registrosTabela');
            tabela.innerHTML = '';
            
            // USAR PER√çODO DE C√ÅLCULO EM VEZ DE M√äS/ANO FIXO
            const registrosPeriodo = getRegistrosPorPeriodo();
            
            // Ordenar por data (mais recente primeiro)
            registrosPeriodo.sort((a, b) => new Date(b.data) - new Date(a.data));
            
            document.getElementById('totalRegistros').textContent = registrosPeriodo.length;
            
            if (registrosPeriodo.length === 0) {
                tabela.innerHTML = '<tr><td colspan="7" class="border border-gray-300 px-4 py-2 text-center text-gray-500">Nenhum registro encontrado para este per√≠odo</td></tr>';
                return;
            }
            
            registrosPeriodo.forEach(registro => {
                const tr = document.createElement('tr');
                tr.className = 'time-entry';
                
                // USAR FUN√á√ÉO CORRIGIDA PARA FORMATAR DATA
                const dataFormatada = toBrazilianDate(registro.data);
                
                // Calcular horas extras (se aplic√°vel)
                const horasExtras = calcularHorasExtras(registro.totalHoras);
                const temHorasExtras = horasExtras !== '00:00';
                
                tr.innerHTML = `
                    <td class="border border-gray-300 px-4 py-2">${dataFormatada}</td>
                    <td class="border border-gray-300 px-4 py-2">${registro.entrada}</td>
                    <td class="border border-gray-300 px-4 py-2">${registro.saida}</td>
                    <td class="border border-gray-300 px-4 py-2">${registro.intervaloSaida && registro.intervaloRetorno ? `${registro.intervaloSaida} - ${registro.intervaloRetorno}` : '-'}</td>
                    <td class="border border-gray-300 px-4 py-2 ${temHorasExtras ? 'font-bold text-green-600' : ''}">${registro.totalHoras} ${temHorasExtras ? `(+${horasExtras})` : ''}</td>
                    <td class="border border-gray-300 px-4 py-2">${registro.observacoes || '-'}</td>
                    <td class="border border-gray-300 px-4 py-2 no-print">
                        <button class="btn-primary bg-blue-500 hover:bg-blue-600 text-white px-2 py-1 rounded text-sm mr-1 edit-btn" data-id="${registro.id}">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="btn-primary bg-red-500 hover:bg-red-600 text-white px-2 py-1 rounded text-sm delete-btn" data-id="${registro.id}">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                `;
                
                tabela.appendChild(tr);
            });
            
            // Adicionar eventos aos bot√µes de edi√ß√£o e exclus√£o
            document.querySelectorAll('.edit-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const id = parseInt(this.dataset.id);
                    abrirModalEdicao(id);
                });
            });
            
            document.querySelectorAll('.delete-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const id = parseInt(this.dataset.id);
                    excluirRegistro(id);
                });
            });
            
            // Atualizar c√°lculos
            atualizarCalculos();
        }

        function calcularHorasExtras(totalHoras) {
            // Considerar 8 horas como jornada padr√£o
            const [horas, minutos] = totalHoras.split(':').map(Number);
            const totalMinutos = horas * 60 + minutos;
            
            if (totalMinutos <= 8 * 60) {
                return '00:00';
            }
            
            const extrasMinutos = totalMinutos - (8 * 60);
            const extrasHoras = Math.floor(extrasMinutos / 60);
            const extrasMins = extrasMinutos % 60;
            
            return `${extrasHoras.toString().padStart(2, '0')}:${extrasMins.toString().padStart(2, '0')}`;
        }

        async function abrirModalEdicao(id) {
            const registro = registros.find(r => r.id === id);
            if (!registro) return;
            
            document.getElementById('editId').value = registro.id;
            document.getElementById('editData').value = registro.data; // J√° est√° no formato correto
            document.getElementById('editEntrada').value = registro.entrada;
            document.getElementById('editSaida').value = registro.saida;
            document.getElementById('editIntervaloSaida').value = registro.intervaloSaida || '';
            document.getElementById('editIntervaloRetorno').value = registro.intervaloRetorno || '';
            document.getElementById('editObservacoes').value = registro.observacoes || '';
            
            document.getElementById('editModal').classList.remove('hidden');
        }

        function fecharModalEdicao() {
            document.getElementById('editModal').classList.add('hidden');
        }

        async function handleEditSubmit(e) {
            e.preventDefault();
            
            const id = parseInt(document.getElementById('editId').value);
            const data = document.getElementById('editData').value;
            const entrada = document.getElementById('editEntrada').value;
            const saida = document.getElementById('editSaida').value;
            const intervaloSaida = document.getElementById('editIntervaloSaida').value;
            const intervaloRetorno = document.getElementById('editIntervaloRetorno').value;
            const observacoes = document.getElementById('editObservacoes').value;
            
            if (!data || !entrada || !saida) {
                showToast('Preencha pelo menos data, entrada e sa√≠da', 'error');
                return;
            }
            
            // CORRE√á√ÉO: Garantir que a data seja salva exatamente como informada
            const dataCorrigida = toISODate(data);
            
            // Encontrar e atualizar registro
            const index = registros.findIndex(r => r.id === id);
            if (index === -1) return;
            
            // Recalcular total de horas (mantendo hor√°rios adicionais existentes)
            const horariosAdicionais = registros[index].horariosAdicionais || [];
            const totalHoras = calcularHorasTrabalhadas(entrada, saida, intervaloSaida, intervaloRetorno, horariosAdicionais);
            
            registros[index] = {
                ...registros[index],
                data: dataCorrigida, // Usar data corrigida
                entrada,
                saida,
                intervaloSaida: intervaloSaida || '',
                intervaloRetorno: intervaloRetorno || '',
                totalHoras,
                observacoes
            };
            
            // Salvar dados
            await saveUserData();
            
            // Atualizar interface
            carregarRegistrosMes();
            atualizarDashboard();
            fecharModalEdicao();
            
            showToast('Registro atualizado com sucesso!', 'success');
        }

        async function excluirRegistro(id) {
            if (!confirm('Tem certeza que deseja excluir este registro?')) {
                return;
            }
            
            registros = registros.filter(r => r.id !== id);
            
            // Salvar dados
            await saveUserData();
            
            // Atualizar interface
            carregarRegistrosMes();
            atualizarDashboard();
            
            showToast('Registro exclu√≠do com sucesso!', 'success');
        }

        function limparFormulario() {
            document.getElementById('pontoForm').reset();
            document.getElementById('horariosAdicionais').innerHTML = '';
            // Restaurar data atual corrigida
            document.getElementById('data').value = getCurrentBrazilianDate();
        }

        function adicionarHorario() {
            const container = document.getElementById('horariosAdicionais');
            const div = document.createElement('div');
            div.className = 'horario-adicional grid grid-cols-2 gap-4';
            div.innerHTML = `
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Entrada:</label>
                    <input type="time" class="entrada-adicional modern-input">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Sa√≠da:</label>
                    <input type="time" class="saida-adicional modern-input">
                </div>
            `;
            container.appendChild(div);
        }

        // =============================================
        // FUN√á√ïES DE C√ÅLCULO DE SAL√ÅRIO
        // =============================================
        function atualizarCalculos() {
            if (workMode === 'horista') {
                atualizarCalculosHorista();
            } else {
                atualizarCalculosMensalista();
            }
        }

        function atualizarCalculosHorista() {
            // USAR REGISTROS DO PER√çODO EM VEZ DO M√äS
            const registrosPeriodo = getRegistrosPorPeriodo();
            
            // Calcular totais
            let totalHoras = 0;
            let totalMinutos = 0;
            let totalHorasExtras = 0;
            let totalMinutosExtras = 0;
            
            registrosPeriodo.forEach(reg => {
                const [horas, minutos] = reg.totalHoras.split(':').map(Number);
                totalHoras += horas;
                totalMinutos += minutos;
                
                // Calcular horas extras
                const horasExtras = calcularHorasExtras(reg.totalHoras);
                if (horasExtras !== '00:00') {
                    const [hExtras, mExtras] = horasExtras.split(':').map(Number);
                    totalHorasExtras += hExtras;
                    totalMinutosExtras += mExtras;
                }
            });
            
            // Ajustar minutos (convertendo para horas)
            totalHoras += Math.floor(totalMinutos / 60);
            totalMinutos = totalMinutos % 60;
            
            totalHorasExtras += Math.floor(totalMinutosExtras / 60);
            totalMinutosExtras = totalMinutosExtras % 60;
            
            const totalHorasFormatado = `${totalHoras.toString().padStart(2, '0')}:${totalMinutos.toString().padStart(2, '0')}`;
            const totalHorasExtrasFormatado = `${totalHorasExtras.toString().padStart(2, '0')}:${totalMinutosExtras.toString().padStart(2, '0')}`;
            
            // Atualizar totais na interface
            document.getElementById('totalHoras').textContent = totalHorasFormatado;
            document.getElementById('infoTotalHoras').textContent = `${totalHoras}h ${totalMinutos}min`;
            document.getElementById('infoHorasExtras').textContent = `${totalHorasExtras}h ${totalMinutosExtras}min`;
            
            // Calcular sal√°rio
            const valorHora = parseFloat(document.getElementById('valorHoraAula').value) || 0;
            const percentualHoraExtra = parseInt(document.getElementById('valorHoraExtra').value) || 0;
            
            const valorHoraExtra = valorHora * (1 + percentualHoraExtra / 100);
            
            const totalMinutosTrabalhados = totalHoras * 60 + totalMinutos;
            const totalMinutosExtrasTrabalhados = totalHorasExtras * 60 + totalMinutosExtras;
            const totalMinutosNormais = totalMinutosTrabalhados - totalMinutosExtrasTrabalhados;
            
            const salarioHorasNormais = (totalMinutosNormais / 60) * valorHora;
            const salarioHorasExtras = (totalMinutosExtrasTrabalhados / 60) * valorHoraExtra;
            const salarioBruto = salarioHorasNormais + salarioHorasExtras;
            
            document.getElementById('infoValorHora').textContent = `R$ ${valorHora.toFixed(2)}`;
            document.getElementById('infoSalarioBruto').textContent = `R$ ${salarioBruto.toFixed(2)}`;
            document.getElementById('salarioLiquido').textContent = `R$ ${salarioBruto.toFixed(2)}`;
            
            // Atualizar dashboard
            document.getElementById('dashboardHorasMes').textContent = totalHorasFormatado;
            document.getElementById('dashboardSalarioMes').textContent = `R$ ${salarioBruto.toFixed(2)}`;
            document.getElementById('dashboardHorasExtras').textContent = totalHorasExtrasFormatado;
            
            // Calcular m√©dia semanal
            const semanasNoPeriodo = Math.ceil(registrosPeriodo.length / 5); // Aproxima√ß√£o
            const mediaSemanalHoras = semanasNoPeriodo > 0 ? totalHoras / semanasNoPeriodo : 0;
            const mediaHoras = Math.floor(mediaSemanalHoras);
            const mediaMinutos = Math.round((mediaSemanalHoras - mediaHoras) * 60);
            document.getElementById('dashboardMediaSemanal').textContent = `${mediaHoras.toString().padStart(2, '0')}:${mediaMinutos.toString().padStart(2, '0')}`;
            
            // Atualizar gr√°ficos
            atualizarGraficos(registrosPeriodo);
        }

        function atualizarCalculosMensalista() {
            // USAR REGISTROS DO PER√çODO EM VEZ DO M√äS
            const registrosPeriodo = getRegistrosPorPeriodo();
            
            // Calcular totais
            let totalHoras = 0;
            let totalMinutos = 0;
            
            registrosPeriodo.forEach(reg => {
                const [horas, minutos] = reg.totalHoras.split(':').map(Number);
                totalHoras += horas;
                totalMinutos += minutos;
            });
            
            // Ajustar minutos (convertendo para horas)
            totalHoras += Math.floor(totalMinutos / 60);
            totalMinutos = totalMinutos % 60;
            
            const totalHorasFormatado = `${totalHoras.toString().padStart(2, '0')}:${totalMinutos.toString().padStart(2, '0')}`;
            
            // Atualizar totais na interface
            document.getElementById('totalHoras').textContent = totalHorasFormatado;
            document.getElementById('infoTotalHoras').textContent = `${totalHoras}h ${totalMinutos}min`;
            
            // Configura√ß√µes de mensalista
            const cargaHorariaMensal = parseInt(document.getElementById('cargaHorariaMensal').value) || 160;
            const salarioMensal = parseFloat(document.getElementById('salarioMensal').value) || 3000.00;
            
            // Calcular horas a compensar/pagar
            const totalMinutosTrabalhados = totalHoras * 60 + totalMinutos;
            const cargaHorariaMinutos = cargaHorariaMensal * 60;
            
            const diferencaMinutos = totalMinutosTrabalhados - cargaHorariaMinutos;
            const diferencaHoras = Math.floor(Math.abs(diferencaMinutos) / 60);
            const diferencaMinutosRestantes = Math.abs(diferencaMinutos) % 60;
            
            const diferencaFormatada = `${diferencaHoras.toString().padStart(2, '0')}:${diferencaMinutosRestantes.toString().padStart(2, '0')}`;
            
            // Calcular valor a compensar/pagar
            const valorHora = salarioMensal / cargaHorariaMensal;
            const valorDiferenca = (Math.abs(diferencaMinutos) / 60) * valorHora;
            
            // Atualizar interface
            document.getElementById('horasTrabalhadasMensal').textContent = totalHorasFormatado;
            
            if (diferencaMinutos > 0) {
                // Horas extras
                document.getElementById('horasCompensar').textContent = `+${diferencaFormatada}`;
                document.getElementById('horasCompensar').className = 'text-green-600 font-bold';
                document.getElementById('valorCompensar').textContent = `R$ ${valorDiferenca.toFixed(2)}`;
                document.getElementById('valorCompensar').className = 'text-green-600 font-bold';
            } else if (diferencaMinutos < 0) {
                // Horas faltantes
                document.getElementById('horasCompensar').textContent = `-${diferencaFormatada}`;
                document.getElementById('horasCompensar').className = 'text-red-600 font-bold';
                document.getElementById('valorCompensar').textContent = `-R$ ${valorDiferenca.toFixed(2)}`;
                document.getElementById('valorCompensar').className = 'text-red-600 font-bold';
            } else {
                // Exatamente a carga hor√°ria
                document.getElementById('horasCompensar').textContent = '00:00';
                document.getElementById('horasCompensar').className = '';
                document.getElementById('valorCompensar').textContent = 'R$ 0,00';
                document.getElementById('valorCompensar').className = '';
            }
            
            // Sal√°rio l√≠quido √© o sal√°rio mensal ajustado pela diferen√ßa
            let salarioLiquido = salarioMensal;
            if (diferencaMinutos > 0) {
                salarioLiquido += valorDiferenca;
            } else if (diferencaMinutos < 0) {
                salarioLiquido -= valorDiferenca;
            }
            
            document.getElementById('salarioLiquido').textContent = `R$ ${salarioLiquido.toFixed(2)}`;
            
            // Atualizar dashboard
            document.getElementById('dashboardHorasMes').textContent = totalHorasFormatado;
            document.getElementById('dashboardSalarioMes').textContent = `R$ ${salarioLiquido.toFixed(2)}`;
            document.getElementById('dashboardHorasExtras').textContent = diferencaMinutos > 0 ? `+${diferencaFormatada}` : '00:00';
            
            // Calcular m√©dia semanal
            const semanasNoPeriodo = Math.ceil(registrosPeriodo.length / 5); // Aproxima√ß√£o
            const mediaSemanalHoras = semanasNoPeriodo > 0 ? totalHoras / semanasNoPeriodo : 0;
            const mediaHoras = Math.floor(mediaSemanalHoras);
            const mediaMinutos = Math.round((mediaSemanalHoras - mediaHoras) * 60);
            document.getElementById('dashboardMediaSemanal').textContent = `${mediaHoras.toString().padStart(2, '0')}:${mediaMinutos.toString().padStart(2, '0')}`;
            
            // Atualizar gr√°ficos
            atualizarGraficos(registrosPeriodo);
        }

        function calcularSalarioCompleto() {
            if (workMode === 'horista') {
                calcularSalarioHorista();
            } else {
                calcularSalarioMensalista();
            }
        }

        function calcularSalarioHorista() {
            // USAR REGISTROS DO PER√çODO
            const registrosPeriodo = getRegistrosPorPeriodo();
            
            // Calcular totais
            let totalHoras = 0;
            let totalMinutos = 0;
            let totalHorasExtras = 0;
            let totalMinutosExtras = 0;
            
            registrosPeriodo.forEach(reg => {
                const [horas, minutos] = reg.totalHoras.split(':').map(Number);
                totalHoras += horas;
                totalMinutos += minutos;
                
                // Calcular horas extras
                const horasExtras = calcularHorasExtras(reg.totalHoras);
                if (horasExtras !== '00:00') {
                    const [hExtras, mExtras] = horasExtras.split(':').map(Number);
                    totalHorasExtras += hExtras;
                    totalMinutosExtras += mExtras;
                }
            });
            
            // Ajustar minutos
            totalHoras += Math.floor(totalMinutos / 60);
            totalMinutos = totalMinutos % 60;
            
            totalHorasExtras += Math.floor(totalMinutosExtras / 60);
            totalMinutosExtras = totalMinutosExtras % 60;
            
            // Calcular valores
            const valorHora = parseFloat(document.getElementById('valorHoraAula').value) || 0;
            const percentualHoraExtra = parseInt(document.getElementById('valorHoraExtra').value) || 0;
            const valorHoraExtra = valorHora * (1 + percentualHoraExtra / 100);
            
            const totalMinutosTrabalhados = totalHoras * 60 + totalMinutos;
            const totalMinutosExtrasTrabalhados = totalHorasExtras * 60 + totalMinutosExtras;
            const totalMinutosNormais = totalMinutosTrabalhados - totalMinutosExtrasTrabalhados;
            
            const salarioHorasNormais = (totalMinutosNormais / 60) * valorHora;
            const salarioHorasExtras = (totalMinutosExtrasTrabalhados / 60) * valorHoraExtra;
            let salarioBruto = salarioHorasNormais + salarioHorasExtras;
            
            // Aplicar descontos
            const descontos = getDescontos();
            let totalDescontos = 0;
            descontos.forEach(desc => {
                if (desc.tipo === 'valor') {
                    totalDescontos += parseFloat(desc.valor);
                } else if (desc.tipo === 'percentual') {
                    totalDescontos += salarioBruto * (parseFloat(desc.valor) / 100);
                }
            });
            
            const salarioLiquido = salarioBruto - totalDescontos;
            
            // Mostrar resultado
            const resultContent = document.getElementById('resultContent');
            resultContent.innerHTML = `
                <div class="flex justify-between">
                    <span>Total de Horas:</span>
                    <span>${totalHoras}h ${totalMinutos}min</span>
                </div>
                <div class="flex justify-between">
                    <span>Horas Extras:</span>
                    <span>${totalHorasExtras}h ${totalMinutosExtras}min</span>
                </div>
                <div class="flex justify-between">
                    <span>Valor Hora/Aula:</span>
                    <span>R$ ${valorHora.toFixed(2)}</span>
                </div>
                <div class="flex justify-between">
                    <span>Valor Hora Extra:</span>
                    <span>R$ ${valorHoraExtra.toFixed(2)}</span>
                </div>
                <div class="flex justify-between border-t pt-2">
                    <span>Sal√°rio Bruto:</span>
                    <span>R$ ${salarioBruto.toFixed(2)}</span>
                </div>
                <div class="flex justify-between">
                    <span>Descontos:</span>
                    <span>- R$ ${totalDescontos.toFixed(2)}</span>
                </div>
                <div class="flex justify-between font-bold border-t pt-2">
                    <span>Sal√°rio L√≠quido:</span>
                    <span>R$ ${salarioLiquido.toFixed(2)}</span>
                </div>
            `;
            
            document.getElementById('resultModal').classList.remove('hidden');
        }

        function calcularSalarioMensalista() {
            // USAR REGISTROS DO PER√çODO
            const registrosPeriodo = getRegistrosPorPeriodo();
            
            // Calcular totais
            let totalHoras = 0;
            let totalMinutos = 0;
            
            registrosPeriodo.forEach(reg => {
                const [horas, minutos] = reg.totalHoras.split(':').map(Number);
                totalHoras += horas;
                totalMinutos += minutos;
            });
            
            // Ajustar minutos
            totalHoras += Math.floor(totalMinutos / 60);
            totalMinutos = totalMinutos % 60;
            
            // Configura√ß√µes de mensalista
            const cargaHorariaMensal = parseInt(document.getElementById('cargaHorariaMensal').value) || 160;
            const salarioMensal = parseFloat(document.getElementById('salarioMensal').value) || 3000.00;
            
            // Calcular horas a compensar/pagar
            const totalMinutosTrabalhados = totalHoras * 60 + totalMinutos;
            const cargaHorariaMinutos = cargaHorariaMensal * 60;
            
            const diferencaMinutos = totalMinutosTrabalhados - cargaHorariaMinutos;
            const diferencaHoras = Math.floor(Math.abs(diferencaMinutos) / 60);
            const diferencaMinutosRestantes = Math.abs(diferencaMinutos) % 60;
            
            const valorHora = salarioMensal / cargaHorariaMensal;
            const valorDiferenca = (Math.abs(diferencaMinutos) / 60) * valorHora;
            
            let salarioLiquido = salarioMensal;
            if (diferencaMinutos > 0) {
                salarioLiquido += valorDiferenca;
            } else if (diferencaMinutos < 0) {
                salarioLiquido -= valorDiferenca;
            }
            
            // Aplicar descontos
            const descontos = getDescontos();
            let totalDescontos = 0;
            descontos.forEach(desc => {
                if (desc.tipo === 'valor') {
                    totalDescontos += parseFloat(desc.valor);
                } else if (desc.tipo === 'percentual') {
                    totalDescontos += salarioLiquido * (parseFloat(desc.valor) / 100);
                }
            });
            
            salarioLiquido -= totalDescontos;
            
            // Mostrar resultado
            const resultContent = document.getElementById('resultContent');
            resultContent.innerHTML = `
                <div class="flex justify-between">
                    <span>Sal√°rio Base:</span>
                    <span>R$ ${salarioMensal.toFixed(2)}</span>
                </div>
                <div class="flex justify-between">
                    <span>Carga Hor√°ria:</span>
                    <span>${cargaHorariaMensal}h</span>
                </div>
                <div class="flex justify-between">
                    <span>Horas Trabalhadas:</span>
                    <span>${totalHoras}h ${totalMinutos}min</span>
                </div>
                <div class="flex justify-between">
                    <span>Diferen√ßa:</span>
                    <span>${diferencaMinutos > 0 ? '+' : ''}${diferencaHoras}h ${diferencaMinutosRestantes}min</span>
                </div>
                <div class="flex justify-between">
                    <span>Valor da Diferen√ßa:</span>
                    <span>${diferencaMinutos > 0 ? '+' : '-'}R$ ${valorDiferenca.toFixed(2)}</span>
                </div>
                <div class="flex justify-between border-t pt-2">
                    <span>Sal√°rio Ajustado:</span>
                    <span>R$ ${(salarioMensal + (diferencaMinutos > 0 ? valorDiferenca : -valorDiferenca)).toFixed(2)}</span>
                </div>
                <div class="flex justify-between">
                    <span>Descontos:</span>
                    <span>- R$ ${totalDescontos.toFixed(2)}</span>
                </div>
                <div class="flex justify-between font-bold border-t pt-2">
                    <span>Sal√°rio L√≠quido:</span>
                    <span>R$ ${salarioLiquido.toFixed(2)}</span>
                </div>
            `;
            
            document.getElementById('resultModal').classList.remove('hidden');
        }

        function fecharModalResultado() {
            document.getElementById('resultModal').classList.add('hidden');
        }

        // =============================================
        // FUN√á√ïES DE DESCONTOS
        // =============================================
        function adicionarDesconto() {
            const container = document.getElementById('descontosContainer');
            const id = Date.now();
            const div = document.createElement('div');
            div.className = 'desconto-item grid grid-cols-1 md:grid-cols-5 gap-2 mb-2';
            div.innerHTML = `
                <input type="text" class="modern-input desconto-descricao" placeholder="Descri√ß√£o">
                <select class="modern-input desconto-tipo">
                    <option value="valor">Valor (R$)</option>
                    <option value="percentual">Percentual (%)</option>
                </select>
                <input type="number" class="modern-input desconto-valor" step="0.01" min="0" placeholder="Valor">
                <button type="button" class="btn-primary bg-red-500 hover:bg-red-600 remover-desconto" data-id="${id}">
                    <i class="fas fa-times"></i>
                </button>
            `;
            container.appendChild(div);
            
            // Adicionar evento de remo√ß√£o
            div.querySelector('.remover-desconto').addEventListener('click', function() {
                div.remove();
                saveUserData();
            });
            
            // Salvar quando alterar
            div.querySelectorAll('input, select').forEach(el => {
                el.addEventListener('change', saveUserData);
            });
        }

        function loadDescontos(descontos) {
            const container = document.getElementById('descontosContainer');
            container.innerHTML = '';
            
            if (descontos && descontos.length > 0) {
                descontos.forEach(desc => {
                    const div = document.createElement('div');
                    div.className = 'desconto-item grid grid-cols-1 md:grid-cols-5 gap-2 mb-2';
                    div.innerHTML = `
                        <input type="text" class="modern-input desconto-descricao" placeholder="Descri√ß√£o" value="${desc.descricao || ''}">
                        <select class="modern-input desconto-tipo">
                            <option value="valor" ${desc.tipo === 'valor' ? 'selected' : ''}>Valor (R$)</option>
                            <option value="percentual" ${desc.tipo === 'percentual' ? 'selected' : ''}>Percentual (%)</option>
                        </select>
                        <input type="number" class="modern-input desconto-valor" step="0.01" min="0" placeholder="Valor" value="${desc.valor || ''}">
                        <button type="button" class="btn-primary bg-red-500 hover:bg-red-600 remover-desconto">
                            <i class="fas fa-times"></i>
                        </button>
                    `;
                    container.appendChild(div);
                    
                    // Adicionar evento de remo√ß√£o
                    div.querySelector('.remover-desconto').addEventListener('click', function() {
                        div.remove();
                        saveUserData();
                    });
                    
                    // Salvar quando alterar
                    div.querySelectorAll('input, select').forEach(el => {
                        el.addEventListener('change', saveUserData);
                    });
                });
            }
        }

        function getDescontos() {
            const descontos = [];
            document.querySelectorAll('.desconto-item').forEach(item => {
                const descricao = item.querySelector('.desconto-descricao').value;
                const tipo = item.querySelector('.desconto-tipo').value;
                const valor = item.querySelector('.desconto-valor').value;
                
                if (descricao && valor) {
                    descontos.push({
                        descricao,
                        tipo,
                        valor: parseFloat(valor)
                    });
                }
            });
            return descontos;
        }

        // =============================================
        // FUN√á√ïES DE GR√ÅFICOS
        // =============================================
        function atualizarGraficos(registrosPeriodo) {
            atualizarGraficoHorasSemanais(registrosPeriodo);
            atualizarGraficoHorasDiarias(registrosPeriodo);
        }

        function atualizarGraficoHorasSemanais(registrosPeriodo) {
            const ctx = document.getElementById('horasSemanaisChart').getContext('2d');
            
            // Agrupar por semana
            const semanas = {};
            registrosPeriodo.forEach(reg => {
                const data = new Date(reg.data);
                // Obter n√∫mero da semana no m√™s
                const firstDay = new Date(data.getFullYear(), data.getMonth(), 1);
                const firstDayWeekday = firstDay.getDay();
                const offsetDate = data.getDate() + firstDayWeekday - 1;
                const semana = Math.floor(offsetDate / 7) + 1;
                
                if (!semanas[semana]) {
                    semanas[semana] = 0;
                }
                
                const [horas, minutos] = reg.totalHoras.split(':').map(Number);
                semanas[semana] += horas + (minutos / 60);
            });
            
            // Preparar dados para o gr√°fico
            const labels = Object.keys(semanas).map(s => `Semana ${s}`);
            const data = Object.values(semanas);
            
            // Destruir gr√°fico existente se houver
            if (window.horasSemanaisChartInstance) {
                window.horasSemanaisChartInstance.destroy();
            }
            
            // Criar novo gr√°fico
            window.horasSemanaisChartInstance = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Horas Trabalhadas',
                        data: data,
                        backgroundColor: 'rgba(59, 130, 246, 0.7)',
                        borderColor: 'rgba(59, 130, 246, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Horas'
                            }
                        }
                    }
                }
            });
        }

        function atualizarGraficoHorasDiarias(registrosPeriodo) {
            const ctx = document.getElementById('horasDiariasChart').getContext('2d');
            
            // Ordenar registros por data
            registrosPeriodo.sort((a, b) => new Date(a.data) - new Date(b.data));
            
            // Preparar dados para o gr√°fico
            const labels = registrosPeriodo.map(reg => {
                const data = new Date(reg.data);
                return data.getDate().toString().padStart(2, '0') + '/' + (data.getMonth() + 1).toString().padStart(2, '0');
            });
            
            const data = registrosPeriodo.map(reg => {
                const [horas, minutos] = reg.totalHoras.split(':').map(Number);
                return horas + (minutos / 60);
            });
            
            // Destruir gr√°fico existente se houver
            if (window.horasDiariasChartInstance) {
                window.horasDiariasChartInstance.destroy();
            }
            
            // Criar novo gr√°fico
            window.horasDiariasChartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Horas por Dia',
                        data: data,
                        backgroundColor: 'rgba(16, 185, 129, 0.2)',
                        borderColor: 'rgba(16, 185, 129, 1)',
                        borderWidth: 2,
                        tension: 0.3,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Horas'
                            }
                        }
                    }
                }
            });
        }

        // =============================================
        // FUN√á√ïES DE DASHBOARD
        // =============================================
        function atualizarDashboard() {
            // Esta fun√ß√£o √© chamada por atualizarCalculos()
            // Os valores s√£o atualizados l√°
        }

        // =============================================
        // FUN√á√ïES DE NAVEGA√á√ÉO
        // =============================================
        function initializeYearSelect() {
            const select = document.getElementById('yearSelect');
            const currentYear = new Date().getFullYear();
            
            // Adicionar op√ß√µes para os √∫ltimos 5 anos e pr√≥ximos 2
            for (let i = currentYear - 5; i <= currentYear + 2; i++) {
                const option = document.createElement('option');
                option.value = i;
                option.textContent = i;
                if (i === currentYear) {
                    option.selected = true;
                }
                select.appendChild(option);
            }
        }

        function updateMonthTabs() {
            document.querySelectorAll('.month-tab').forEach(tab => {
                tab.classList.remove('tab-active', 'bg-blue-100', 'text-blue-800');
                
                if (parseInt(tab.dataset.month) === currentMonth) {
                    tab.classList.add('tab-active', 'bg-blue-100', 'text-blue-800');
                }
                
                tab.addEventListener('click', function() {
                    currentMonth = parseInt(this.dataset.month);
                    updateMonthTabs();
                    carregarRegistrosMes();
                });
            });
        }

        // =============================================
        // FUN√á√ïES DE MODO DE TRABALHO
        // =============================================
        function updateWorkModeUI() {
            const indicator = document.getElementById('workModeIndicator');
            const mensalistaConfig = document.getElementById('mensalistaConfig');
            
            if (workMode === 'horista') {
                indicator.textContent = 'Horista';
                indicator.className = 'work-mode-indicator work-mode-horista';
                mensalistaConfig.classList.add('hidden');
            } else {
                indicator.textContent = 'Mensalista';
                indicator.className = 'work-mode-indicator work-mode-mensalista';
                mensalistaConfig.classList.remove('hidden');
            }
            
            // Atualizar c√°lculos
            atualizarCalculos();
        }

        function loadMensalistaConfig() {
            // Esta fun√ß√£o √© chamada no carregamento dos dados do usu√°rio
        }

        async function saveMensalistaConfig() {
            await saveUserData();
            atualizarCalculos();
        }

        // =============================================
        // FUN√á√ïES DE ADMINISTRA√á√ÉO
        // =============================================
        function loadUsersList() {
            const usersList = document.getElementById('usersList');
            usersList.innerHTML = '';
            
            Object.keys(usersData).forEach(username => {
                if (username === 'admin') return;
                
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td class="border border-gray-300 px-4 py-2">${username}</td>
                    <td class="border border-gray-300 px-4 py-2">
                        <button class="btn-primary bg-red-500 hover:bg-red-600 text-white px-2 py-1 rounded text-sm delete-user-btn" data-username="${username}">
                            <i class="fas fa-trash"></i> Excluir
                        </button>
                    </td>
                `;
                usersList.appendChild(tr);
            });
            
            // Adicionar eventos aos bot√µes de exclus√£o
            document.querySelectorAll('.delete-user-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const username = this.dataset.username;
                    deleteUser(username);
                });
            });
        }

        async function deleteUser(username) {
            if (!confirm(`Tem certeza que deseja excluir o usu√°rio "${username}"? Todos os dados ser√£o perdidos.`)) {
                return;
            }
            
            delete usersData[username];
            await saveAllUsersData();
            loadUsersList();
            showToast('Usu√°rio exclu√≠do com sucesso!', 'success');
        }

        async function changeAdminPassword() {
            const currentPassword = document.getElementById('currentPassword').value;
            const newPassword = document.getElementById('newPassword').value;
            const confirmNewPassword = document.getElementById('confirmNewPassword').value;
            
            if (!currentPassword || !newPassword || !confirmNewPassword) {
                showToast('Preencha todos os campos', 'error');
                return;
            }
            
            if (newPassword !== confirmNewPassword) {
                showToast('As novas senhas n√£o coincidem', 'error');
                return;
            }
            
            if (newPassword.length < 4) {
                showToast('A nova senha deve ter pelo menos 4 caracteres', 'error');
                return;
            }
            
            // Verificar senha atual
            if (usersData.admin.password !== currentPassword) {
                showToast('Senha atual incorreta', 'error');
                return;
            }
            
            // Atualizar senha
            usersData.admin.password = newPassword;
            await saveAllUsersData();
            
            // Limpar formul√°rio
            document.getElementById('currentPassword').value = '';
            document.getElementById('newPassword').value = '';
            document.getElementById('confirmNewPassword').value = '';
            
            showToast('Senha alterada com sucesso!', 'success');
        }

        async function createUser() {
            const username = document.getElementById('newUsername').value;
            const password = document.getElementById('newUserPassword').value;
            const confirmPassword = document.getElementById('confirmNewUserPassword').value;
            
            if (!username || !password || !confirmPassword) {
                showToast('Preencha todos os campos', 'error');
                return;
            }
            
            if (password !== confirmPassword) {
                showToast('As senhas n√£o coincidem', 'error');
                return;
            }
            
            if (username.length < 3) {
                showToast('O usu√°rio deve ter pelo menos 3 caracteres', 'error');
                return;
            }
            
            if (password.length < 4) {
                showToast('A senha deve ter pelo menos 4 caracteres', 'error');
                return;
            }
            
            // Verificar se o usu√°rio j√° existe
            if (usersData[username]) {
                showToast('Este usu√°rio j√° existe', 'error');
                return;
            }
            
            // Criar novo usu√°rio
            usersData[username] = {
                password: password,
                registros: [],
                settings: {
                    valorHoraAula: 50.00,
                    valorHoraExtra: 50,
                    workMode: 'horista',
                    calculationPeriod: calculationPeriod, // Salvar configura√ß√£o do per√≠odo
                    mensalistaConfig: {
                        cargaHorariaMensal: 160,
                        salarioMensal: 3000.00
                    }
                },
                descontos: []
            };
            
            await saveAllUsersData();
            
            // Limpar formul√°rio
            document.getElementById('newUsername').value = '';
            document.getElementById('newUserPassword').value = '';
            document.getElementById('confirmNewUserPassword').value = '';
            
            // Atualizar lista
            loadUsersList();
            
            showToast('Usu√°rio criado com sucesso!', 'success');
        }

        // =============================================
        // FUN√á√ïES UTILIT√ÅRIAS
        // =============================================
        function showToast(message, type = 'success') {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.className = `toast ${type} show`;
            
            setTimeout(() => {
                toast.classList.remove('show');
            }, 3000);
        }

        function toggleDarkMode() {
            document.body.classList.toggle('dark-mode');
            const button = document.getElementById('darkModeToggle');
            if (document.body.classList.contains('dark-mode')) {
                button.innerHTML = '<i class="fas fa-sun"></i> Modo Claro';
            } else {
                button.innerHTML = '<i class="fas fa-moon"></i> Modo Escuro';
            }
        }

        function imprimirRelatorio() {
            window.print();
        }

        function exportarDados() {
            const dataToExport = {
                usuario: currentUser.username,
                registros: registros,
                settings: usersData[currentUser.username]?.settings || {},
                descontos: getDescontos(),
                exportDate: new Date().toISOString()
            };
            
            const dataStr = JSON.stringify(dataToExport, null, 2);
            const dataBlob = new Blob([dataStr], { type: 'application/json' });
            
            const url = URL.createObjectURL(dataBlob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `ponto-${currentUser.username}-${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            showToast('Dados exportados com sucesso!', 'success');
        }

        function importarDados() {
            const fileInput = document.getElementById('importFile');
            const file = fileInput.files[0];
            
            if (!file) {
                showToast('Selecione um arquivo para importar', 'error');
                return;
            }
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const importedData = JSON.parse(e.target.result);
                    
                    // Verificar se os dados s√£o compat√≠veis
                    if (!importedData.registros || !Array.isArray(importedData.registros)) {
                        showToast('Arquivo inv√°lido: formato n√£o reconhecido', 'error');
                        return;
                    }
                    
                    if (confirm('Isso substituir√° todos os seus registros atuais. Continuar?')) {
                        // Substituir registros
                        registros = importedData.registros;
                        
                        // Atualizar configura√ß√µes se existirem
                        if (importedData.settings) {
                            usersData[currentUser.username].settings = importedData.settings;
                        }
                        
                        // Atualizar descontos se existirem
                        if (importedData.descontos) {
                            loadDescontos(importedData.descontos);
                        }
                        
                        // Salvar dados
                        saveUserData();
                        
                        // Atualizar interface
                        carregarRegistrosMes();
                        atualizarDashboard();
                        
                        showToast('Dados importados com sucesso!', 'success');
                    }
                } catch (error) {
                    console.error('Erro ao importar dados:', error);
                    showToast('Erro ao importar dados: arquivo inv√°lido', 'error');
                }
            };
            
            reader.readAsText(file);
            fileInput.value = ''; // Limpar sele√ß√£o
        }
    </script>
</body>
</html>